<!-- -*- coding: utf-8 -*- -->
<span id="slides-title" hidden>Уровни машинных языков и наборы инструкций</span>

# Машинные языки

- - - - - -

## Уровни машинных языков

<div style="text-align: center;">

[![Levels](images/03.levels.g.svg)](images/03.levels.g.svg)  <!--.element: style="width: 100%;" -->

</div>

- - - - - -

## Пример программы и результата её трансляции (1)

@pause@

Исходный код:

```
int a, b;   bool res;
a = a + b;
b = 3 * b;
if ( a>b ) res = true;
   else   res = false;

```

@pause@

32-битный x86 код


```<!--.element: style="font-size: small;" -->
Адрес   Машинный язык (код)   Команды процессора                     Комментарий
------- --------------------- -------------------------------------- ----------------------------------------------
00      8b 45 f4              mov    eax,DWORD PTR [ebp-0xc]       загрузка в регистр а (пам→рег)
03      03 45 f8              add    eax,DWORD PTR [ebp-0x8]       загрузка в регистр b (пам→рег) и сложение
06      89 45 f4              mov    DWORD PTR [ebp-0xc],eax       выгрузка a из регистра (рег→пам)
09      6b 4d f8 03           imul   ecx,DWORD PTR [ebp-0x8],0x3   загрузка b в регистр (пам→рег) и умнож. на 3
0d      89 4d f8              mov    DWORD PTR [ebp-0x8],ecx       выгрузка b из регистра (рег→пам)
10      8b 55 f4              mov    edx,DWORD PTR [ebp-0xc]       загрузка а в регистр (пам→рег)
13      3b 55 f8              cmp    edx,DWORD PTR [ebp-0x8]       сравнение a и b (а>b)
16      7e 06                 jle    1e                              условный переход на метку LN2 (a<=b)
18      c6 45 ff 01           mov    BYTE PTR [ebp-0x1],0x1        res = true
1c      eb 04                 jmp    22                              безусловный переход на метку LN3
1e      c6 45 ff 00           mov    BYTE PTR [ebp-0x1],0x0        res = false
22                                                                   
```

- - - - - -

## Пример программы и результата её трансляции (2)

ARMv7 (большинство современных смартфонов)

```
ldr r2,[sp,#8]
ldr r3,[sp,#4]
add r3,r3,r2
str r3,[sp,#8]
ldr r2,[sp,#4]
movs r3,#3
mul r3,r2,r3
str r3,[sp,#4]
ldr r2,[sp,#8]
ldr r3,[sp,#4]
cmp r2,r3
ble |$LN2@main|
movs r3,#1
strb r3,[sp]
b |$LN3@main|
|$LN2@main|
movs r3,#0
strb r3,[sp]
|$LN3@main|
movs r3,#0
```

- - - - - -

## Что отличало данные примеры?

**Система команд** — соглашение о средствах, предоставляемых машинным языком и о структуре машинного языка

@pause@


<div style="text-align: center;">

[![Levels](images/03.instr_sets.png)](images/03.instr_sets.png)  <!--.element: style="width: 60%;" -->

</div>

\* Орлов С.А., Цилькер Б.Я. Организация   ЭВМ   и   систем:  Учебник   для   вузов.  2-е   изд.  —  СПб.:  Питер, 2011. — 688 с.<!--.element: style="font-size: smaller;" -->

= = = = = =

# CISC, RISC, VLIW

- - - - - -

## CISC

**CISC** — Complicated Instruction Set Computer

* Много способов адресовать аргументы команд
  * Смешанная адресация — разные операнды из разных мест
* Команды похожи на операторы языков высокого уровня
* Ассемблер дружественный
* Небольшое количество *сильно умных* команд
  * Реализованы при помощи *микропрограмм*
* Машинный код экономный в смысле занимаемого места в памяти (многие «популярные» команды занимают 1 байт)

### Примеры:

IBM/360..z-Architecture, Intel x86 и x86_64, Intel 8080 и Zilog Z80


- - - - - -

## RISC

**RISC** — Reduced Instruction Set Computer

* Отдельные команды для обмена данными с памятью
* Команды простые
* Команды выполняются за фиксированное время
  * Это упрощает конвейеризацию, о ней позже
  * Некоторые «долгие» команды выполняются асинхронно
* Ассемблер недружественный
  * Подробнее, опять же, в лекции про конвейеризацию =)
* Машинный код не экономный, все команды занимают одно машинное слово

### Примеры:

Cray CDC 6600, MIPS, SPARC, ARM

- - - - - -

## CISC vs RISC: недружественный ассемблер

Это страшно?

@pause@

Нет.

<div style="text-align: center;">

[![Levels](images/03.generation_prices.png)](images/03.generation_prices.png)  <!--.element: style="width: 90%;" -->

</div>

* Cray CDC 6600 — суперкомпьютер середины 1960-х, можно было программировать дорого 
* Остальные — 1980-е и позже, программируются на языках высокого уровня


\* Архитектура вычислительных систем.: Учеб. пособие. 2-e изд., перераб. и доп. M.: Изд-во МГТУ им. H.Э. Баумана, 2008. 520 c.<!--.element: style="font-size: smaller;" -->

- - - - - -

## Что такое микропрограмма (1)

ARM v7:

```
SDIV Rd, Rn, Rm ; Rd = Rn / Rm
```

Intel x86 (даже сложнее =)):

```
idiv ebx              ; EDX:EAX / EBX. Quotient saved to EAX, remainder in EDX
idiv DWORD PTR [var]  ; EDX:EAX / 32-bit value stored at memory location var. Quotient in EAX, remainder in EDX
```

А что генерирует компилятор при целочисленном делении, например, на 167?

@pause@

Intel x86:


```
mov     ecx, DWORD PTR [rbp-20]
mov     edx, 1645975491
mov     eax, ecx
imul    edx
```

А почему?

@pause@

А потому, что медленно

- - - - - -

## Что такое микропрограмма (2)

**Микропрограмма** — программа, описывающая реализацию сложных машинных команд. Например, деления.

**Микрокод**, расположенный в **МикроПЗУ** — представление микропрограмм.

Микропрограмма, в отличие от привычных программ, управляет сопряжением блоков процессора,
которые *существуют всё время*. Поэтому она по возможности должна их задействовать параллельно.

@pause@

* Некоторые архитектуры позволяют дополнять микрокод для реализации эффективных команд под специфические задачи
* Исправлениями в микрокоде исправляются некоторые уязвимости, например [Meltdown и Spectre](https://meltdownattack.com/), опубликованные в 2018 г.
* Также производители обновляют микрокод для исправления ошибок и общей оптимизации

- - - - - -

## VLIW

**VLIW** — Very Long Instruction Word — класс архитектур систем команд, команды которых управляют несколькими блоками процессора параллельно.

Пример:

```
 R5=R1+R2, R6=R3+R4 ; каждое АЛУ складывает свою пару чисел
 R0=R5+R6, NOP      ; первое АЛУ находит сумму, второе простаивает
```

### Примеры:

* Эльбрус-3
* Intel Itanium
* Многие современные GPU и DSP

@pause@

### Особенности

* Распараллеливание выполняет компилятор
  * А в CISC — сам процессор (но компилятор не должен мешать =)); позже, в лекции про конвейеризацию
* Чем-то напоминает микрокод
* Хорошо для предсказуемых вычислений (GPU, DSP)

= = = = = =

# Стековые архитектуры

- - - - - -

## Идея

**Стековая архитектура** — архитектура системы команд, оперирующая данными не в регистрах, а на (и вблизи) вершины стека

@pause@

## Достоинства и недостатки

Достоинства

- красиво и просто
- хорошо компилируется код

Недостатки

- ухищрения для хранения верхушки стека внутри процессора
- плохо распараллеливаются

- - - - - -

## Примеры

### Калькуляторы

-   США, 1970-е [HP-25](http://en.wikipedia.org/wiki/HP-25),
    [HP-65](http://en.wikipedia.org/wiki/HP-65)
-   СССР, 1980-е [МК-61](http://ru.wikipedia.org/wiki/%D0%9C%D0%9A-61),
    [МК-61](http://ru.wikipedia.org/wiki/%D0%9C%D0%9A-52)

### Компьютеры

- США, 1960-е — Burroughs [B5500, B6500](https://en.wikipedia.org/wiki/Burroughs_large_systems#B5000)
- США, 1970-е–80-е — [Lisp-Машины](http://en.wikipedia.org/wiki/Lisp_machine)
- СССР, 1980-е – 1990-е годы.\
  Арифметика на стеке, микропрограммирование, 16-битные. Ухищрения для
  хранения верхушки стека внутри процессора.
  - Самсон (ЛГУ)
  - Кронос (НГУ)
    - Кронос потом сделали 32-битным
- США, 2010 — [GreenArray](http://www.greenarraychips.com/) — 144-ядерный, ориентированный на стековый язык Forth
- США, 2000-е — частично стековый VLIW — [Intel Itanium](https://en.wikipedia.org/wiki/Itanium)

= = = = = =

# Виртуальные машины

- - - - - -

**Виртуальная машина** — программа, имитирующая исполнение машинного кода на вычислительной машине

* Может имитировать существующие ЭВМ (симуляторы)
* Может имитировать создаваемые ЭВМ (чтобы можно было их одновременно программировать и разрабатывать)
* Может изначально быть «чисто виртуальной»

@pause@

Большинство современных интерпретаторов содержат виртуальные машины.
Действительно «исполняют исходный код» лишь простейшие, например, командные оболочки.


- - - - - -

## Интерпретаторы

Плюсы

-   не требуют сборки ПО
-   проще в реализации
-   больше информации при отладке

Минусы

-   ошибки, в основном, на стадии выполнения
-   медленно работают
-   для быстрой работы требуют откомпилированных внешних библиотек

- - - - - -

## Компиляторы

Плюсы

-   компилирует в быстрый код
-   код достаточно автономен (не требует наличия интерпретатора)
-   контроль многих ошибок при компиляции

Минусы

-   сложнее писать
-   долго собирается ПО
-   меньше информации для отладки

- - - - - -

Виртуальные машины
------------------

Минусы ВМ

-   медленнее компилированного кода
-   медленно запускаются, особенно при JIT
-   вообще довольно здоровые, особенно из-за Framework
-   кроме всего прочего требуют компилятора, наследуя почти все минусы
    компиляции

Плюсы ВМ

-   быстрее интерпретатора
-   много информации во время выполнения
-   по прежнему поддерживают откомпилированные внешние библиотеки
-   поддерживают JIT и AOT (ниже) для повышения производительности
-   делают уже откомпилированный код независимым от платформы и системы
-   часто поставляются с очень большими библиотеками с одинаковым
    интерфейсом под разные платформы - Framework
-   удобная компиляция и отладка, т.к.
    -   стековые компиляторы проще
    -   для отладки много возможностей

- - - - - -

## JIT и AOT: понятия

* **Байт-код** — машинный код «чисто» виртуальной машины
  * название появилось исторически — у многих ВМ инструкция занимала 1 байт, хотя сейчас это не обязательно
* **Just-in-Time** (JIT)-компиляция — генерация машинного кода «на лету» при интерпретации программы
  * обычно — генерация машинного кода «настоящей» ЭВМ по байт-коду
* **Ahead-of-Time** (AOT)-компиляция — генерация машинного кода по байт-коду заранее с сохранением результата
  * практически как обычная компиляция

JIT и AOT могут сосуществовать

@pause@

JIT, обладая информацией времени выполнения, иногда генерирует более оптимальный код, чем AOT или традиционный компилятор

- - - - - -

## JIT и AOT: пример MS .NET

<div style="text-align: center;">

[![Levels](images/03.jit-aot.g.svg)](images/03.jit-aot.g.svg)  <!--.element: style="width: 100%;" -->

</div>

- - - - - -

Примеры
-------

Стековые

- Lilith
- AVE
- Python, многие другие интерпретаторы
- интерпретаторы конкатенативных языков (Forth и друзья)
- JVM
- .NET CLI

Регистровые

- LLVM (на самом деле — промежуточное представление, а не ВМ)
- Parrot (Ruby, Perl)


= = = = = =

# Упражнения и вопросы

### Упражнения

* Пользуясь знаниями теории чисел, объясните, каким
  образом компилятор генерирует целочисленное деление
  на константу при помощи умножения
* Познакомьтесь с языком Forth, напишите любую простую программу (например, решение квадратного уравнения)

### Вопросы

* Что такое система команд?
* Объясните смысл аббревиатур CISC, RISC, VLIW
* Что такое микропрограмма? Зачем она нужна?
* Приведите примеры CISC-, RISC- и VLIW- архитектур
* Что такое стековая архитектура?
* Каковы достоинства и недостатки стековых ЭВМ?
* Приведите примеры стековых ЭВМ
* Что такое виртуальная машина?
* Что такое байт-код, JIT, AOT?
* Приведите примеры виртуальных машин
