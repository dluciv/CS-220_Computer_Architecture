<!-- -*- coding: utf-8 -*- -->
<span id="slides-title" hidden>Вычислительный конвейер</span>

# Вычислительный конвейер

- - - - - -

## Снова немного про CISC и RISC

* 1960-е — CISC
  * много сложных и умных команд, дружественный машинных язык (и ассемблер)
  * разработка ПО на фоне общей цены IT-проектов сравнительно недорого 
* 1980-е — RISC
  * команды более простые и глупые, недружественный машинный язык (и ассемблер)
  * разработка ПО в IT-проектах — значительная часть бюджета
  * где логика?..

@pause@

В 1970-х – 80-х массовая разработка на языках высокого уровня, поэтому «страдает» не программист, а компилятор

- - - - - -

## Пример без конвейера

Команда сложения числа из регистра с числом из памяти `add eax, DWORD PTR [ebp-0x8]` в процессоре  Intel 80386

1. выполняется чтение числа из регистра `eax`
2. выполняется чтение  значения адресного регистра `ebp`
3. вычисляется адрес в памяти для второго операнда
4. выполняется чтение по этому адресу числа из памяти
5. выполняется сложение двух чисел
6. результат записывается в регистр `eax`

При этом

* Вся команда выполняется за 6 тактов
  * на самом деле это совпадение: не все перечисленные операции выполняются за один такт, но некоторые могут перекрываться по времени
* На каждом такте задействуется лишь часть блоков процессора, а остальные простаивают
  * например, в момент сложения полученного из памяти числа со значением в регистре `eax` блок работы с памятью простаивает

- - - - - -

## Распараллеливание: путь к конвейеру

* Эли Уитни, 1798 (оружейное производство) — одновременное изготовление стандартизованных узлов мушкета разными  рабочими, затем быстрая сборка готовых изделий
* Генри Форд, 1913 и т.д. — сборка электрогенераторов, затем моторов и целых автомобилей
  * Разные этапы производства выполняются разными рабочими
  * Рабочие работают одновременно, каждый на своём этапе
* Конвейер в системе образования
  * Школа: 1–11 классы — выпуск каждый год, но школьник учится 11 лет
  * Высшее образование: старая поговорка — *Матмех — не школа, за 10 лет не окончишь* =)
* Конвейер в менеджменте
  * Конвейерное исполнение заказов

- - - - - -

## Недостатки конвейера

* Низкая гибкость — организованный и запущенный конвейер тяжело приспособить к изменяющейся ситуации
* Снижение качества результата в угоду массовости
  * Пример: товар есть на складе в моём городе, но почему-то едет с другого конца страны

Выходы:

* В менеджменте это преодолевается переходом от конвейера к организации бизнес-процессов — сложнее, но адаптивнее

= = = = = =

# Вычислительный конвейер

- - - - - -

## Пример: Classic RISC Pipeline

<div style="text-align: center;">

![](images/08.classic-RISC-pipeline.png) <!--.element: style="width: 80%;" -->

</div>

* Скорость выполнения отдельных команд
  * Каждая команда выполняется за 5 тактов как с конвейером, так и без
  * В отношении одной команды на разных тактах задействованы разные блоки
* Скорость выполнения программы
  * На каждом такте завершается очередная команда
  * Конвейеризация ускоряет работу программы в 5 раз (в данном примере), все блоки задействованы всё время

@pause@

Косвенная выгода:  «сосредоточение» отдельных стадий в компактных блоках позволяет увеличить тактовую частоту

- - - - - -

## Что же такое конвейер?

**Вычислительный конвейер** — механизм распараллеливания выполнения машинных команд, позволяющий оптимально задействовать блоки процессора путём разбиения команд на стадии и распределения стадий по блокам

@pause@

Конвейеры появились в 1950-х годах, термин «конвейер» (pipline) ввёл конструктор советских ЭВМ С.А. Лебедев.

Синонимы: *водопровод*, английский термин — *pipeline*

- - - - - -

## Проблемы конвейеризации

1. Конфликты по данным между зависимыми машинными командами, например: 
  * самая частая ситуация — следующей команде нужен результат предыдущей, но предыдущая ещё его не получила 
  * следующая команда записывает данные до того, как их читает предыдущая 
  * следующая команда записывает свои результаты раньше предыдущей из-за чего предыдущая потом может их перезаписать

@pause@

2. Конфликты по ресурсам — когда двум командам одновременно нужен эксклюзивный доступ к чему-либо

@pause@

3. Конфликты по управлению: следующая команда является условным переходом, но условие для него ещё не вычислено предыдущей командой
  * и даже не ясно, из какой ветви дальше выбирать команды

- - - - - -

## Решения

* Pipeline Stall — торможение команд на конвейере; в предельном случае может свести преимущества конвейеризации на нет
* Предсказание условных переходов — сбор статистики о переходах или подсказки от компилятора

- - - - - -

## Специфика RISC

У RISC простой формат машинного кода (пример — ARMv7):

<div style="text-align: center;">

![](images/08.ARMv7-code-format.png) <!--.element: style="width: 75%;" -->

</div>

* Простой блок выборки инструкций, простой конвейер
* Есть несколько «долгих» команд, которые выполняются асинхронно

@pause@

Многие RISC-семейства не отслеживают конфликты и не обрабатывают их!

- - - - - -

## Решения для RISC

* Переупорядочивание команд — конфликтующие команды размещаются «на безопасном расстоянии» друг от друга
* Торможение при помощи вставки «пузырька» (инструкция `nop`, no operation)

Всё это делает компилятор или программист!

@pause@

Некоторые RISC-семейства даже после безусловного перехода успевают «затянуть» на конвейер пару команд

- - - - - -

## Решения для CISC

Процессор полностью сам отвечает за корректное исполнение кода

* Обнаруживает конфликты
* Обрабатывает их

- - - - - -

To be continued

= = = = = =

## Вопросы

* ...

## Упражнения

* ...
