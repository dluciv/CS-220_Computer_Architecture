<!-- -*- coding: utf-8 -*- -->
<span id="slides-title" hidden>Адресное пространство и виртуальная память</span>

# Прямая адресация

- - - - - -

## Сущность прямой адресации

<!-- ![image](images/mem-models.pdf){width="100%"} -->
Картинка

* **Физический адрес** — номер байта в оперативной памяти, начиная с нулевого
* **Логический адрес** — адрес, с которым работает прикладное ПО, например, значение указателя
* **Адресное пространство** — множество логических адресов
* **Прямая адресация** — способ адресации, при которой физический адрес равен логическому

- - - - - -

## Свойства прямой адресации

- Типично для восьмибитной шины данных — 16-битные внутренняя
  арифметика и шина адреса.

- Изначально даже возможные 64KiB не использовались

Для офисных приложений и игр — нужна графика и больше памяти.

= = = = = =

# Банковые расширения

- - - - - -

## Сущность банковых расширений

<!-- ![image](images/mem-models.pdf){width="100%"} -->
Картинка

**Банковая адресация** — способ адресации, при которой адресное пространство
разделяется на *банки адресного пространства*, которым в соответствие ставятся
*банки оперативной памяти*

Соответствие обычно не произвольное, варианты ограничены

- - - - - -

## Свойства банковых расширений

Хорошо

- Процессор тот же
- Дешево стоит
- Память можно расширять произвольно, доступно радиолюбителям
- Сравнительно удобно работать с данными

Плохо

- Работает небыстро
- Программируется через порты; тяжело менять банки кода, особенно для:
  - Вызова процедур
  - Прерываний
  - Переключения задач
-   Разные расширения часто несовместимы

- - - - - -

## Пример 1: ZX Spectrum 128K

[ZX Spectrum 128K](http://www.worldofspectrum.org/faq/reference/128kreference.htm)


```
0xffff +--------+--------+--------+--------+--------+--------+--------+--------+
       | Bank 0 | Bank 1 | Bank 2 | Bank 3 | Bank 4 | Bank 5 | Bank 6 | Bank 7 |
       |        |        |(also at|        |        |(also at|        |        |
       |        |        | 0x8000)|        |        | 0x4000)|        |        |
       |        |        |        |        |        | screen |        | screen |
0xc000 +--------+--------+--------+--------+--------+--------+--------+--------+
       | Bank 2 |        Any one of these pages may be switched in.
       |        |
       |        |
       |        |
0x8000 +--------+
       | Bank 5 |
       |        |
       |        |
       | screen |
0x4000 +--------+--------+
       | ROM 0  | ROM 1  | Either ROM may be switched in.
       |        |        |
       |        |        |
       |        |        |
0x0000 +--------+--------+
```

- - - - - -

## Пример 2: Окна в адресном пространстве

Можно рассматривать, как вариант банковой системы

- Некоторые внешние устройства, например графические адаптеры, поддерживают до
  сих пор
- Использовалась в EMS — сначала плата расширения, затем встроенная
  поддержка на материнской плате, затем эмуляция при помощи страничной адресации

@pause@

- Использовалась в XMS — сразу чисто программное решение (эмуляция), Intel 80286+

= = = = = =

Совместимые расширения и эволюция ЦП
=========================

Расширение адресных регистров
-----------------------------

Расширение адресных регистров

-   Старый машинный код не знает, что у адресного регистра есть старшая
    половинка

-   Все переходы и обращения к данным в старом коде \<\<короткие\>\>

-   Т.к. старые приложения не используют всю память, появляется
    внутренняя фрагментация

Сегментная и страничнaя модели
------------------------------

Жёсткие сегменты Дополнительный сегментный регистр для жестких сегментов

-   Определяет, сколько надо прибавить к текущему адресу (с умножением
    на 16 (8086) или 256 (80286)). Сегменты пересекаются, это
    минимизирует внутреннюю фрагментацию.

-   Инструкции передачи управления, вызова и прерывания с ним работают.

-   Для данных тоже приятен, но отдельный.

-   Хорошо бы еще и для стека (особенно, если много задач), и для данных
    сделать несколько.

Управляемые сегменты

-   Произвольного размера

-   Требуют специальных таблиц размещения

-   Могут ассоциироваться с правами на хранение данных и кода и
    выполнение кода

Страничная адресация: Сущность
![image](images/mem-models.pdf){height="0.85\textheight"}

Страничная адресация: Свойства

-   Страницы небольшие и не пересекаются

-   В отличие от жестких сегментов, часто могут "гулять" по физическим
    адресам под управлением ОС.

-   Для управляемых страниц нужны таблицы размещения в основной памяти,
    к которым обращается ЦП $\Rightarrow$ нужен хороший (и
    спец-оптимизированный кэш)

-   Удобны для реализации виртуальной памяти — их можно выгружать и
    загружать без ведома пользовательского процесса

Пример: Intel i80386
====================

Сегменты i80386

-   Процесс получает сегмент (реже несколько) кода и сегмент (реже
    несколько) данных

-   Процесс получает сегмент стека

-   По прерыванию таймера происходит переход в другой сегмент кода
    (адрес полный обработчика в другом сегменте), при этом автоматом:

    -   регистры сохраняются в стек (на то оно и прерывание)

    -   меняются текущие сегменты стека и данных

-   Сегмент логически до 2 ГиБ — адресные регистры расширены, для работы
    со всем регистром новые инструкции

Адресные регистры по 32 бита вместо 16 В реальном режиме старшие разряды
игнорируются

Страницы i80386

-   Память разбита на страницы по 4 КиБ, в отдельных таблицах указано их
    размещение в основной памяти. Независимо от сегментов. Это дает
    возможности:

    -   выделять физическую память по мере использования, даже если
        процесс сразу запросил много

    -   не перемещать данные физически, если надо перенастроить сегменты
        процесса

-   Маленькие одинаковые страницы позволяют эффективно реализовать
    виртуальную память больше физической — с подкачкой. при отсутствии
    нужной страницы в физической памяти она загружается с диска. Тоже
    через прерывание.

При этом (I)

-   Тормоза — сначала надо читать таблицы дескрипторов сегментов, потом
    страниц $\Rightarrow$ нужен умный кэш

-   Обратная совместимость — процесс может пользоваться младшими 16
    битами адресного регистра, как и раньше

-   Старым процессам, рассчитанным на жесткие сегменты, выделяются
    сегменты, пересекающиеся, как раньше (реальный режим)

-   Про страницы пользовательский процесс не знает вообще ничего

-   По прерываниям таймера переход идет на диспетчер процессов, а он уже
    дает переход на следующий процесс, выбирая его исходя из приоритета

-   По прерываниям отсутствующих страниц переход идет на диспетчер
    виртуальной памяти

При этом (II)

-   Виртуальная память позволяет эмулировать усройства, перехватывая
    отсутствие страниц, адрес которых задан в несуществующей физически
    памяти

    -   Банковые расширения памяти — EMS, например — на месте окна EMS —
        страницы, физически расположенные в несуществующей памяти

    -   Плоские адресные буферы внешних устройств, например, видеокарт,
        в действительности не поддерживающих их
        [](http://ru.wikipedia.org/wiki/UniVBE). Для видеокарты задан
        сегмент в разделе памяти целиком из подложных страниц, а по
        прерыванию переключается её окно.

-   386 адресует до 4 ГиБ физической и до 64 ТиБ виртуальной, при этом
    виртуальная м.б. тоже реализована, как физическая, хоть и не
    адресуется на прямую (и вновь банки, ведь чем буфер НЖМД не банк?..)

Модель памяти

[](http://en.wikipedia.org/wiki/Protected_mode#Paging)\
Сранинчо-сегментное преобразование.\
[](http://www.lib.csu.ru/dl/bases/prg/frolov/books/bsp/v06/ch5.htm#ch5_4)\
[](http://upload.wikimedia.org/wikipedia/commons/e/ef/Intel_80386_adress.png)

![image](images/Intel_80386_adress.png){width="\textwidth"}

Дальнейшие расширения

-   Устройства располагают свою память в 4-м ГиБ, так что, если
    установлено 4 ГиБ, часть памяти перекроется (будет недоступно).

-   4 ГиБ может быть тоже мало.

Проблема решается при помощи Physical Address Extension — доп.
расширения, появившегося в Pentium Pro (на тот момент — для серверов).
Расширение позволяет страницам памяти располагаться не в контексте 4 ГиБ
ОЗУ, а в контексте 64 ТиБ ОЗУ, по объему совпадающим с виртуальной
памятью. При этом изменяется формат дескрипторов сегментов и страниц.

Пользовательские процессы обычно не работают с памятью такого объема,
для них всё выглядит по-старому. Картина меняется для ядра. Программы,
которым объем памяти критичен, можно пересобрать со специальными
библиотеками.
