<!-- -*- coding: utf-8 -*- -->
<span id="slides-title" hidden>Ввод/вывод: прерывания и DMA</span>

# Прерывания

- - - - - -

## Вспоминаем: архитектура фон Неймана

<div style="text-align: center;">

![HA](images/03.Von_Neumann_System_Bus.svg)  <!--.element: style="width: 40%;" -->

</div>

- - - - - -

## Оборудование и ПО

* **Контроллер** — устройство в составе ЭВМ, обеспечивающее связь системной шины с внешним устройством
  * Например, контроллер жёсткого диска, котроллер порта USB
* **Драйвер устройства** — ПО, предоставляемое производителем устройства
  * Реализует низкоуровневые операции работы с устройством
  * Позволяет абстрагироваться от модели оборудования. Например: для прикладного ПО и ОС все принтеры «одинаковые», т.к. разные драйвера принтеров  реализует один и тот же стандартный интерфейс

- - - - - -

## Ситуации

@pause@

### «Системные горячие клавиши»

Alt+Ctrl+Del на PC:

* немедленная перезагрузка (DOS)
* завершение и перезагрузка (Linux)
* вызова системного меню (Windows)

При этом ни ОС, ни, тем более, пользовательская программа, не проверяют всё время: не нажали ли Alt+Ctrl+Del?

@pause@

### Мышь

* Ни прикладные программы, ни ОС не опрашивают мышь постоянно
* Тем не менее, «что-то» реагирует на движение мыши и отображает на экране движущийся указатель

- - - - - -

## Аппаратное прерывание

**Аппаратное прерывание** — сигнал, сообщающий ЦП о возникновении ситуации, требующей немедленной обработки

* Обычно этот сигнал генерируют контроллеры внешних устройств
* Обработка ситуации выполняется программно
* Текущая выполняемая программа «не замечает» того, что процессор «отвлёкся», и после обработки ситуации продолжается

- - - - - -

## Обработка прерываний

* Запускается и работает ОС
  * ОС регистрирует адреса специальных процедур — обработчиков прерываний; обработчик прерывания — часть драйвера устройства
  * Прерываний от разных устройств множество (они имеют номера), адреса обработчиков помещаются в специальный массив в ОЗУ — вектор прерываний
* Запускается и работает прикладное ПО
  * Выполняется программа
  * Получив сигнал от устройства (например, мыши), контроллер посылает сигнал ЦП о необходимости его обработки (проверить, на сколько переместили мышь, какие кнопки нажали)
  * ЦП заканчивает выполнение очередной инструкции, а вместо следующей производит вызов процедуры — обработчика прерывания. Эта процедура — не часть прикладной программы
  * После завершения обработчика прерывания продолжается выполнение прикладной программы

- - - - - -

## Вектор и обработчики прерываний

<div style="text-align: center;">

[![Levels](images/04.interrupt_vector.png)](images/04.interrupt_vector.png)  <!--.element: style="width: 60%;" -->

</div>

- - - - - -

## Обработка прерываний

<div style="text-align: center;">

[![Levels](images/04.interrupt_invokation.png)](images/04.interrupt_invokation.png)  <!--.element: style="width: 60%;" -->

</div>

- - - - - -

...

= = = = = =

# Другие способы использования прерываний

- - - - - -

## Косвенный вызов API ОС

* Прерывание генерируется программно, на PC — машинная команда `int <номер>`
* Вектор прерываний фактически хранит адреса части системных функций
* Это позволяет менять адреса системного кода, не меняя машинного кода пользовательских программ

### Где это использвоалось?

* Вызов API BIOS для управления графикой (`int 0x10`) и DOS (`int 0x21`)
  * Пример

```
mov ah, 0x0e    ; function number = 0Eh : Display Character
mov al, '!'     ; AL = code of character to display
int 0x10        ; call INT 10h, BIOS video service
```

* Вызов API Windows старых версий (`int 2Eh`)

Этот способ удобный, но механизм прерываний небыстрый

@pause@

### А сейчас?

* Windows и Linux используют `syscall` (64-битный режим) и `sysenter` (32-битный режим). Подробнее здесь: https://habr.com/ru/post/347596/

- - - - - -

## Обработка внутренних событий ЦП

Вызов драйвера виртуальной памяти, когда страница памяти выгружена или не проинициализирована

О виртуальной памяти позже

= = = = = =

# DMA

- - - - - -

...

- - - - - -

# DMA для потоковых устройств реального времени

<div style="text-align: center;">

[![Levels](images/04.interrupt_DMA.png)](images/04.interrupt_DMA.png)  <!--.element: style="width: 90%;" -->

</div>


= = = = = =

# Упражнения и вопросы

TODO

### Упражнения

* ...

### Вопросы

* ...