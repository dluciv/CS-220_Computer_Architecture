<!-- -*- coding: utf-8 -*- -->
<span id="slides-title" hidden>Ввод/вывод: прерывания и DMA</span>

# Прерывания

- - - - - -

## Вспоминаем: архитектура фон Неймана

<div style="text-align: center;">

![HA](images/03.Von_Neumann_System_Bus.svg)  <!--.element: style="width: 40%;" -->

</div>

- - - - - -

## Оборудование и ПО

* **Контроллер** — устройство в составе ЭВМ, обеспечивающее связь системной шины с внешним устройством
  * Например, контроллер жёсткого диска, контроллер порта USB
* **Драйвер устройства** — ПО, предоставляемое производителем устройства
  * Реализует низкоуровневые операции работы с устройством
  * Позволяет абстрагироваться от модели оборудования. Например: для прикладного ПО и ОС все принтеры «одинаковые», т.к. разные драйвера принтеров  реализует один и тот же стандартный интерфейс

- - - - - -

## Ситуации

@pause@

### «Системные горячие клавиши»

Ctrl+Alt+Del на PC:

* немедленная перезагрузка (DOS)
* завершение и перезагрузка (Linux)
* вызова системного меню (Windows)

При этом ни ОС, ни, тем более, пользовательская программа, не проверяют всё время: не нажали ли Ctrl+Alt+Del?

@pause@

### Мышь

* Ни прикладные программы, ни ОС не опрашивают мышь постоянно
* Тем не менее, «что-то» реагирует на движение мыши и отображает на экране движущийся указатель

- - - - - -

## Аппаратное прерывание

**Аппаратное прерывание** — сигнал, сообщающий ЦП о возникновении ситуации, требующей немедленной обработки

* Обычно этот сигнал генерируют контроллеры внешних устройств
* Обработка ситуации выполняется программно
* Текущая выполняемая программа «не замечает» того, что процессор «отвлёкся», и после обработки ситуации продолжается

- - - - - -

## Обработка прерываний

* Запускается и работает ОС
  * ОС регистрирует адреса специальных процедур — обработчиков прерываний; обработчик прерывания — часть драйвера устройства
  * Прерываний от разных устройств множество (они имеют номера), адреса обработчиков помещаются в специальный массив в ОЗУ — вектор прерываний
* Запускается и работает прикладное ПО
  * Выполняется программа
  * Получив сигнал от устройства (например, мыши), контроллер посылает сигнал ЦП о необходимости его обработки (проверить, на сколько переместили мышь, какие кнопки нажали)
  * ЦП заканчивает выполнение очередной инструкции, а вместо следующей производит вызов процедуры — обработчика прерывания. Эта процедура — не часть прикладной программы
  * После завершения обработчика прерывания продолжается выполнение прикладной программы

- - - - - -

## Вектор и обработчики прерываний

<div style="text-align: center;">

[![Levels](images/04.interrupt_vector.png)](images/04.interrupt_vector.png)  <!--.element: style="width: 60%;" -->

</div>

- - - - - -

## Обработка прерываний

<div style="text-align: center;">

[![Levels](images/04.interrupt_invokation.png)](images/04.interrupt_invokation.png)  <!--.element: style="width: 60%;" -->

</div>

- - - - - -

## Взаимодействие контроллера с ЦП

Устройство соединено с системной шиной

* реагирует на сигнал шины управления «работа с устройствами»
* проверяет, совпадает ли его идентификатор со значением на шине адреса
* по команде на шине управления может прочитать данные с шины данных или записать на неё
* может генерировать *аппаратные прерывания*, сообщая об этом через шину управления

Адрес устройства — его идентификатор. Не является адресом в смысле адреса данных в ОЗУ, но передаётся по шине адреса

* Соединение устройства с шиной — порт (port)
* Инструкция записи в порт — `out адрес, регистр`
* Инструкция чтения из порта — `in адрес, регистр`

**Порт** — аппаратная и программная абстракция: механизм сопряжения контроллера устройства с системной шиной и механизм программного обращения к контроллеру

Обычно говорят «номер порта» или «адрес порта». У устройства может быть и несколько портов.

- - - - - -

## Немного истории

* В ранних и простых ЭВМ типичным было подключение устройств непосредственно к системной шине.
  Поэтому «порт» — разъём на корпусе и «порт» — способ доступа к устройству были практически синонимами
  * Пример: ZX Spectrum [Interface 1](https://en.wikipedia.org/wiki/ZX_Interface_1) — фактически это был контроллер
* Сейчас разъём на корпусе — обычно способ присоединить устройство к контроллеру в ПК,
  а в устройстве «говорить» с контроллером в ПК будет ответный контроллер
  * Пример: универсальный USB-контроллер в ПК и USB-клавиатура со своим внутренним контроллером
  @pause@
    * Значит прерывание по Ctrl+Alt+Del на USB-клавиатуре генерируется программно драйвером клавиатуры

= = = = = =

# Другие способы использования прерываний

- - - - - -

## Косвенный вызов API ОС

* Прерывание генерируется программно, на PC — машинная команда `int <номер>`
* Вектор прерываний фактически хранит адреса части системных функций
* Это позволяет менять адреса системного кода, не меняя машинного кода пользовательских программ

### Где это использовалось?

* Вызов API BIOS для управления графикой (`int 0x10`) и DOS (`int 0x21`)
  * Пример

```
mov ah, 0x0e    ; function number = 0Eh : Display Character
mov al, '!'     ; AL = code of character to display
int 0x10        ; call INT 10h, BIOS video service
```

* Вызов API ядра Windows (`int 0x2E`)
* Вызов API ядра Linux (`int 0x80`)

Этот способ удобный, но механизм прерываний небыстрый

@pause@

### А сейчас?

* Windows и Linux используют специально разработанные инструкции (`syscall`, `sysenter`) и техники (vDSO). Подробнее здесь: https://habr.com/ru/post/347596/

- - - - - -

## Обработка внутренних событий ЦП

Вызов драйвера виртуальной памяти, когда страница памяти выгружена или не проинициализирована

@pause@

О виртуальной памяти позже

= = = = = =

# DMA

- - - - - -

## Предмет

Внешние устройства могут передавать значительные объёмы информации. Основные способы взаимодействия:

* Чтение и запись в порты. Обмен небольшими порциями данных загружает ЦП
* Выделение контроллеру устройства области памяти и выдача команд, которые выполняются отложено

@pause@

**DMA** (Direct Memory Access) — механизм прямого обмена данными между оперативной памятью и контроллерами устройств

Механизм поддерживается многими контроллерами устройств, предназначенными для передачи значительных объёмов данных. Для небольших данных (например, работа с системными часами) необходимости его использовать нет.

- - - - - -

## Сообщение о завершении операции

Для того, чтобы сообщить о завершении операции, контроллер генерирует аппаратное прерывание. Обработчик прерывания находится в драйвере соответствующего устройства

- - - - - -

## Как настраивается оборудование?

Классический способ первой половины 1980-х — jumpers, DIP switches

![Jumper](images/04.jumper.jpg)

Настраивались *системные ресурсы* — адреса портов, характеристики DMA, номера аппаратных прерываний.
Пример Sound Blaster для DOS: Port 220, IRQ 7, DMA 1

@pause@

* С середины 80-х — разные технологии для ередачи метаданных по системной шине
* Первая широко внедрённая — Plug-n-Play. Первая широко использующая ОС для PC — Windows 95 (жаргон конца 1990-х — Plug and Pray)

@pause@

Посмотреть, какие ресурсы выделены устройствам в популярных ОС можно:

* В Windows — при помощи Диспетчера устройств
* В Linux — при помощи `lsdev` (собирает информацию из `/proc/interrupts`, `/proc/ioports` и `/proc/dma`)

- - - - - -

# DMA для потоковых устройств реального времени

А когда Sound Blaster «доиграет» фрагмент звука, он сгенерирует прерывание, и будет ждать, пока ЦП не выдаст ему ещё данных?..

@pause@

<div style="text-align: center;">

[![DMA Stream](images/04.interrupt_DMA.png)](images/04.interrupt_DMA.png)  <!--.element: style="width: 90%;" -->

</div>

= = = = = =

# Упражнения и вопросы

### Упражнения

* Выберите несколько внутренних контроллеров своего ПК, выясните, какие системные ресурсы им выделены

### Вопросы

* Что такое аппаратное прерывание?
* Что такое драйвер, контроллер и порт?
* Что такое вектор и обработчик прерываний?
* Опишите принцип работы механизма DMA
* Каковы особенности DMA для устройств реального времени?